# Version Locks & Compatibility (Complete Guide)

**Quick Reference**: [CLAUDE.md#version-locks](../CLAUDE.md#version-locks)

---

## Critical Version Requirements

### ShadCN UI Version Lock

**ONLY USE:** ShadCN v2.3.0

#### Why Lock to v2.3.0?

**Problem**: ShadCN v2.4+ requires Tailwind v4, which is incompatible with Wasp 0.18.

```bash
# ❌ WRONG - Uses latest (v2.4+, requires Tailwind v4)
npx shadcn add button

# ✅ CORRECT - Locked to v2.3.0 (Tailwind v3 compatible)
npx shadcn@2.3.0 add button
```

#### After EVERY Component Installation

**MANDATORY MANUAL FIX:**

```typescript
// File: app/src/components/ui/button.tsx (auto-generated by shadcn)

// ❌ WRONG - Auto-generated incorrect import
import { cn } from "s/lib/utils";

// ✅ CORRECT - Must manually fix EVERY time
import { cn } from "../../lib/utils";
```

**Why**: ShadCN v2.3.0 generates incorrect import path (`s/lib/utils` instead of relative path).

#### Complete ShadCN Installation Workflow

```bash
# Step 1: Install component with locked version
npx shadcn@2.3.0 add button

# Step 2: Fix import path in generated file
# File: app/src/components/ui/button.tsx
# Change: import { cn } from 's/lib/utils'
# To:     import { cn } from '../../lib/utils'

# Step 3: Verify no errors
./scripts/safe-start.sh
```

#### Common Error

**Error:**

```
Cannot find module 's/lib/utils'
Module not found: Error: Can't resolve 's/lib/utils'
```

**Fix:**

```typescript
// In affected component (src/components/ui/*.tsx)
-import { cn } from 's/lib/utils'
+import { cn } from '../../lib/utils'
```

#### Available ShadCN Components

**Installed (verified working with v2.3.0):**

- Button
- Card
- Input
- Label
- Select
- Dialog
- Dropdown Menu
- Toast
- [See full list in package.json]

**Installing new components:**

```bash
# ALWAYS use version lock
npx shadcn@2.3.0 add [component-name]

# Then MANUALLY fix import in generated file
```

---

### Node.js Version Lock

**REQUIRED:** Node.js >= 22.12

#### Why This Minimum Version?

Wasp 0.18+ requires Node.js 22.12 or higher for:

- ES Module support
- Native fetch API
- Performance improvements

#### Check Your Version

```bash
node --version
# Should show: v22.12.0 or higher
```

#### Upgrade Node.js (if needed)

**Using nvm (recommended):**

```bash
# Install nvm (if not installed)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# Install Node.js 22.12+
nvm install 22.12

# Set as default
nvm alias default 22.12

# Verify
node --version
```

**Using direct download:**

- Visit: https://nodejs.org/
- Download Node.js 22.12 LTS or higher
- Install and verify

#### Project-Level Lock

**File: `.nvmrc` (in project root):**

```
22.12
```

**Usage:**

```bash
# Auto-switch to correct version
nvm use
```

---

### React Version Lock (Wasp Managed)

**REQUIRED:** React 18.2.0 (Wasp 0.18 compatible)

#### The React 19 Problem

**Timeline:**

- Oct 1, 2025: React 19.2.0 released
- Wasp 0.18: Only supports React 18.x
- After `wasp clean`: npm installs latest React (19.x) → **blank page**

#### Auto-Fix via safe-start.sh

```bash
# ✅ Automatically fixes React version after wasp clean
./scripts/safe-start.sh --clean
```

#### Manual Fix (if needed)

```bash
# Check React version
cat app/.wasp/out/web-app/node_modules/react/package.json | grep version

# If React 19.x detected:
./scripts/fix-react-version.sh

# Or manual npm install:
cd app/.wasp/out/web-app
npm install react@18.2.0 react-dom@18.2.0 --save-exact --legacy-peer-deps
```

#### Why This Happens

**Wasp build process:**

1. `wasp clean` deletes `.wasp/out/` directory
2. `wasp start` regenerates `.wasp/out/web-app/`
3. npm install runs → installs **latest** React (19.x)
4. Wasp 0.18 breaks with React 19 → blank page

**Solution**: `safe-start.sh --clean` auto-fixes after `wasp clean`.

#### Verification

```bash
# After fix, verify React 18.2.0
cat app/.wasp/out/web-app/package.json | grep '"react"'
# Should show: "react": "18.2.0"
```

---

### Wasp Version Lock

**CURRENT:** Wasp ^0.18.0

#### Check Wasp Version

```bash
wasp version
# Should show: 0.18.x
```

#### Upgrade Wasp (when needed)

```bash
# Check for updates
curl -s https://get.wasp-lang.dev/installer.sh | sh

# Verify new version
wasp version
```

**IMPORTANT**: After Wasp upgrade:

1. Check [Wasp changelog](https://github.com/wasp-lang/wasp/releases)
2. Update `main.wasp` if breaking changes
3. Run `wasp db migrate-dev` if schema changes
4. Test thoroughly before deploying

---

### PostgreSQL Version

**RECOMMENDED:** PostgreSQL 14 (via Docker)

#### Docker Image Lock

```bash
# File: scripts/db-manager.sh
POSTGRES_IMAGE="postgres:14"
```

**Why PostgreSQL 14:**

- Stable LTS version
- Prisma 5.x compatible
- Good performance

#### Check PostgreSQL Version

```bash
# In Docker container
docker exec wasp-dev-db-main psql -U dev -c 'SELECT version();'
```

#### Upgrade PostgreSQL (if needed)

```bash
# 1. Backup database
./scripts/db-manager.sh status  # Check which databases running

# 2. Export data
docker exec wasp-dev-db-main pg_dump -U dev dev > backup.sql

# 3. Stop old database
./scripts/db-manager.sh stop

# 4. Update POSTGRES_IMAGE in scripts/db-manager.sh
# Change: POSTGRES_IMAGE="postgres:14"
# To:     POSTGRES_IMAGE="postgres:15"

# 5. Start new database
./scripts/db-manager.sh start

# 6. Import data
cat backup.sql | docker exec -i wasp-dev-db-main psql -U dev dev
```

---

### Prisma Version (Wasp Managed)

**DO NOT manually update Prisma** - Wasp manages Prisma version.

**Current (Wasp 0.18):** Prisma ~5.x

#### Check Prisma Version

```bash
# In Wasp-generated directory
cat app/.wasp/out/server/package.json | grep '"prisma"'
```

#### If Prisma Issues

```bash
# NEVER: npm install prisma@latest
# ALWAYS: Let Wasp manage Prisma version

# Instead, check Wasp version compatibility
wasp version
```

---

### npm/pnpm/yarn Lock

**RECOMMENDED:** npm (Wasp default)

**DO NOT switch to pnpm/yarn** - Wasp generates `package-lock.json` for npm.

---

## Version Matrix

| Component      | Version  | Why                       | Managed By      |
| -------------- | -------- | ------------------------- | --------------- |
| **Node.js**    | >= 22.12 | Wasp 0.18 requirement     | Manual          |
| **Wasp**       | ^0.18.0  | Current project version   | Manual          |
| **React**      | 18.2.0   | Wasp 0.18 compatible      | `safe-start.sh` |
| **ShadCN**     | 2.3.0    | Tailwind v3 compatible    | Manual (locked) |
| **PostgreSQL** | 14       | Stable LTS                | Docker image    |
| **Prisma**     | ~5.x     | Wasp-managed              | Wasp            |
| **Tailwind**   | v3.x     | ShadCN v2.3.0 requirement | Wasp            |
| **TypeScript** | ~5.x     | Wasp-managed              | Wasp            |

---

## Troubleshooting Version Issues

### "Blank page after wasp clean"

**Cause**: React 19 installed instead of React 18

**Fix:**

```bash
./scripts/safe-start.sh --clean  # Auto-fixes
# OR
./scripts/fix-react-version.sh  # Manual fix
```

### "ShadCN component import error"

**Cause**: Import path `s/lib/utils` incorrect

**Fix:**

```typescript
// In src/components/ui/*.tsx
-import { cn } from 's/lib/utils'
+import { cn } from '../../lib/utils'
```

### "Wasp version mismatch"

**Cause**: Project created with older Wasp version

**Fix:**

```bash
# Check current Wasp version
wasp version

# Upgrade Wasp
curl -s https://get.wasp-lang.dev/installer.sh | sh

# Update project
wasp clean
./scripts/safe-start.sh --clean
```

### "Node.js version too old"

**Cause**: Node.js < 22.12

**Fix:**

```bash
# Install Node.js 22.12+
nvm install 22.12
nvm use 22.12

# Verify
node --version
```

---

## Pre-Commit Checklist

Before committing dependency changes:

- [ ] Node.js >= 22.12
- [ ] Wasp ^0.18.0
- [ ] React 18.2.0 (not 19.x)
- [ ] ShadCN components use v2.3.0
- [ ] ShadCN imports fixed (`../../lib/utils`)
- [ ] No manual Prisma version changes
- [ ] `package-lock.json` committed (not `pnpm-lock.yaml`)

---

## See Also

- **[CLAUDE.md#version-locks](../CLAUDE.md#version-locks)** - Quick reference
- **[TROUBLESHOOTING-GUIDE.md](./TROUBLESHOOTING-GUIDE.md)** - Diagnostic procedures
- **[docs/REACT-19-FIX.md](./REACT-19-FIX.md)** - Complete React 19 fix explanation
- **Scripts**: `scripts/fix-react-version.sh` - Auto-fix React version
- **Scripts**: `scripts/safe-start.sh --clean` - Includes React fix
